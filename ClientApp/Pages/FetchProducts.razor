@page "/fetchproducts"
@inject HttpClient Http;
@using ClientApp.Models;
@using System.Text.Json;
@layout MainLayout;

<h2 class="page-title">Product List</h2>

<div class="sort-controls">

    <span class="sort-label">Sort By:</span>

    <button class="sort-btn @(ActiveSort("name"))" @onclick="@(() => ApplySort("name"))">
        Name @SortIcon("name")
    </button>

    <button class="sort-btn @(ActiveSort("price"))" @onclick="@(() => ApplySort("price"))">
        Price @SortIcon("price")
    </button>

    <button class="sort-btn @(ActiveSort("stock"))" @onclick="@(() => ApplySort("stock"))">
        Stock @SortIcon("stock")
    </button>

    <button class="sort-btn @(ActiveSort("dateadded"))" @onclick="@(() => ApplySort("dateadded"))">
        Date Added @SortIcon("dateadded")
    </button>

    <select class="sort-dropdown" @onchange="OnCategoryChanged">
        <option value="">All Categories</option>
        @foreach (var c in categories)
        {
            <option value="@c">@c</option>
        }
    </select>

    <button class="reset-btn" @onclick="ResetSorting">
        Reset
    </button>

</div>

@if (products == null)
{
    <p style="text-align:center;">Loading...</p>
}
else if (products.Length == 0)
{
    <p style="text-align:center;">No products available.</p>
}
else
{
    <p style="text-align:center; color: var(--text-light); margin-bottom: 10px;">
        Showing @products.Length products
    </p>

    <div class="product-grid">
        @foreach (var product in products)
        {
            <div class="product-card">
                <img src="@product.ImageUrl"
                    alt="@product.Name"
                    class="product-image"
                    onerror="this.src='/images/icons/default.png'" />

                <div class="product-info">
                    <div class="product-name">@product.Name</div>
                    <div class="product-category">@product.Category.Name</div>
                    <div class="product-price">$@product.Price</div>
                </div>
            </div>

        }
    </div>
}

@code {

    private Product[]? products = null;   // IMPORTANT FIX
    private List<string> categories = new();
    private string currentSort = "";
    private bool sortAscending = true;
    private string selectedCategory = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(5));

            var response = await Http.GetAsync("http://localhost:5212/api/products", cts.Token);
            response.EnsureSuccessStatusCode();

            var json = await response.Content.ReadAsStringAsync();

            products = JsonSerializer.Deserialize<Product[]>(json, new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            });

            Console.WriteLine($"Loaded {products?.Length ?? 0} products.");

            categories = products!
                .Select(p => p.Category?.Name ?? "")
                .Where(c => !string.IsNullOrWhiteSpace(c))
                .Distinct()
                .OrderBy(c => c)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading products: {ex.Message}");
            products = Array.Empty<Product>();
        }
    }

    private async Task ApplySort(string field)
    {
        if (currentSort == field)
            sortAscending = !sortAscending;
        else
        {
            currentSort = field;
            sortAscending = true;
        }

        var direction = sortAscending ? "asc" : "desc";

        products = await Http.GetFromJsonAsync<Product[]>(
            $"api/products/sorted?sortBy={field}&direction={direction}"
        );
    }

    private string ActiveSort(string field)
        => currentSort == field ? "active-sort" : "";

    private MarkupString SortIcon(string field)
    {
        if (currentSort != field)
            return new MarkupString("");

        return sortAscending
            ? new MarkupString("↑")
            : new MarkupString("↓");
    }

    private async Task OnCategoryChanged(ChangeEventArgs e)
    {
        selectedCategory = e.Value?.ToString() ?? "";

        if (string.IsNullOrWhiteSpace(selectedCategory))
        {
            products = await Http.GetFromJsonAsync<Product[]>("api/products");
        }
        else
        {
            products = await Http.GetFromJsonAsync<Product[]>(
                $"api/products/filter?category={selectedCategory}"
            );
        }
    }

    private async Task ResetSorting()
    {
        currentSort = "";
        sortAscending = true;
        selectedCategory = "";
        products = await Http.GetFromJsonAsync<Product[]>("api/products");
    }
}
